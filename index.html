<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>75 GIFTED</title>

  <!-- montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #e3f2aa;
      --ink: #476313;
      --accent: #eda8ee;

      --card: rgba(255,255,255,0.35);
      --card-border: rgba(71,99,19,0.18);
      --muted: rgba(71,99,19,0.72);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; width:100%; }
    body{
      font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, sans-serif;
      background: var(--bg);
      color: var(--ink);
      overflow: hidden;
      letter-spacing: -0.5px;
    }

    .app{ height:100%; width:100%; display:flex; flex-direction:column; }

    .header{ padding: 16px 18px 10px; text-align:center; }
    .header h1{
      font-size: 28px;
      font-weight: 900; /* always 900 */
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .header .tagline{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: lowercase;
    }

    .content{
      flex:1;
      overflow-y:auto;
      padding: 14px 16px 90px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--card-border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
      margin-bottom: 14px;
      backdrop-filter: blur(8px);
    }

    .subtle{
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-transform: lowercase;
    }

    .accent{
      color: var(--accent);
      font-weight: 700; /* accent text can be 700 */
    }

    .row{ display:flex; gap: 10px; align-items:stretch; }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat{
      padding: 14px 12px;
      text-align:center;
      border-radius: 14px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.25);
    }
    .stat .value{
      font-size: 28px;
      font-weight: 700; /* accent-ish */
      color: var(--accent);
      line-height: 1;
    }
    .stat .label{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: lowercase;
    }

    .countdown{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.25);
      font-size: 12px;
      font-weight: 600;
      color: var(--ink);
      white-space: nowrap;
    }
    .pill .time{ color: var(--accent); font-weight: 700; }

    .chart-wrap{ padding: 12px; }
    canvas{
      width:100%;
      height: 210px;
      display:block;
      border-radius: 14px;
      background: rgba(255,255,255,0.20);
      border: 1px solid var(--card-border);
    }

    .date{
      text-align:center;
      font-weight: 600;
      color: var(--muted);
      text-transform: lowercase;
      margin-top: 2px;
      font-size: 13px;
    }

    .checklist-item{
      display:flex;
      align-items:center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(71,99,19,0.12);
      gap: 10px;
    }
    .checklist-item:last-child{ border-bottom: none; }

    .checkbox{
      appearance:none;
      width: 24px; height: 24px;
      border-radius: 7px;
      border: 2px solid rgba(71,99,19,0.35);
      background: rgba(255,255,255,0.20);
      cursor:pointer;
      position:relative;
      flex: 0 0 auto;
    }
    .checkbox:checked{
      border-color: var(--accent);
      background: rgba(237,168,238,0.25);
    }
    .checkbox:checked::after{
      content:'‚úì';
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--accent);
      font-weight: 700;
      font-size: 14px;
    }

    .label{
      flex:1;
      font-weight: 600;
      text-transform: lowercase;
      color: var(--ink);
      font-size: 14px;
      line-height: 1.25;
    }

    .water-target{
      color: var(--accent);
      font-weight: 700;
      font-size: 12px;
      margin-left: 6px;
    }

    textarea{
      width:100%;
      min-height: 110px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.25);
      padding: 12px;
      font-family: inherit;
      font-size: 14px;
      color: var(--ink);
      resize: vertical;
      outline: none;
      font-weight: 500;
    }

    input[type="date"], input[type="time"], input[type="number"], input[type="text"]{
      width:100%;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.25);
      color: var(--ink);
      font-family: inherit;
      font-weight: 600;
      outline: none;
    }

    .btn{
      width:100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(237,168,238,0.35);
      background: rgba(237,168,238,0.20);
      color: var(--ink);
      font-weight: 700;
      cursor:pointer;
      transition: transform .12s ease, opacity .12s ease;
      text-transform: lowercase;
    }
    .btn:active{ transform: scale(0.99); }
    .btn[disabled]{ opacity: 0.45; cursor:not-allowed; }

    .btn.secondary{
      border: 1px solid rgba(71,99,19,0.22);
      background: rgba(255,255,255,0.18);
      font-weight: 600;
    }

    .btn-row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    /* tabs bottom */
    .tabs{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      display:flex;
      background: rgba(227,242,170,0.92);
      border-top: 1px solid rgba(71,99,19,0.16);
      padding: 10px 10px 14px;
      gap: 10px;
      backdrop-filter: blur(10px);
    }
    .tab{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(71,99,19,0.18);
      background: rgba(255,255,255,0.18);
      padding: 10px 10px;
      font-weight: 700;
      color: var(--ink);
      cursor:pointer;
      text-transform: lowercase;
    }
    .tab.active{
      border-color: rgba(237,168,238,0.50);
      background: rgba(237,168,238,0.18);
      color: var(--accent);
      font-weight: 700;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    /* rules */
    .rules h2{
      font-size: 22px;
      font-weight: 900;
      color: var(--accent);
      text-align:center;
      margin-bottom: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .rules h3{
      font-size: 14px;
      font-weight: 700;
      color: var(--ink);
      margin-top: 14px;
      margin-bottom: 8px;
      text-transform: lowercase;
    }
    .rules p, .rules li{
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      line-height: 1.65;
    }
    .rules ol{
      margin-left: 18px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    /* overlay modal */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .overlay.active{ display:flex; }

    .modal{
      width: min(380px, 92vw);
      background: rgba(255,255,255,0.92);
      border-radius: 18px;
      border: 1px solid rgba(71,99,19,0.18);
      box-shadow: 0 18px 50px rgba(0,0,0,0.18);
      padding: 18px;
      text-align:center;
    }
    .modal .icon{ font-size: 42px; margin-bottom: 8px; }
    .modal .title{ font-size: 18px; font-weight: 700; color: var(--ink); margin-bottom: 6px; }
    .modal .text{
      font-size: 13px;
      font-weight: 600;
      color: rgba(71,99,19,0.75);
      line-height: 1.5;
      margin-bottom: 12px;
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="header">
      <h1>75 GIFTED</h1>
      <div class="tagline">a 75 day spiritual discipline challenge</div>
    </header>

    <main class="content">
      <!-- TODAY -->
      <section id="today" class="section active">
        <div class="card">
          <div class="countdown">
            <div>
              <div class="subtle">today</div>
              <div class="date" id="today-date">‚Äî</div>
            </div>
            <div class="pill" title="time until bedtime">
              bedtime in <span class="time" id="countdown">--:--:--</span>
            </div>
          </div>
          <div style="margin-top:10px;" class="subtle">
            gift: <span class="accent" id="gift-display">set in settings</span>
          </div>
          <div style="margin-top:6px;" class="subtle">
            surrendered: <span class="accent" id="vices-display">set in settings</span>
          </div>
        </div>

        <div class="card chart-wrap">
          <canvas id="streak-chart"></canvas>
          <div class="subtle" style="margin-top:10px; text-align:center;">
            ascension chart (streak resets to 0 on loss)
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="value" id="stat-current">0</div>
            <div class="label">current</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-longest">0</div>
            <div class="label">longest</div>
          </div>
          <div class="stat">
            <div class="value" id="stat-elapsed">0</div>
            <div class="label">days elapsed</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <div class="subtle" style="margin-bottom:8px;">daily checklist</div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-0">
            <label class="label" for="check-0">pray fervently</label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-1">
            <label class="label" for="check-1">
              drink your water goal <span class="water-target" id="water-target"></span>
            </label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-2">
            <label class="label" for="check-2">read bible for 10 minutes</label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-3">
            <label class="label" for="check-3">serve weekly (where God is calling you to give most)</label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-4">
            <label class="label" for="check-4">share your gift publicly: <span class="accent" id="gift-inline">set in settings</span></label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-5">
            <label class="label" for="check-5">45 minutes of movement</label>
          </div>

          <div class="checklist-item">
            <input class="checkbox" type="checkbox" id="check-6">
            <label class="label" for="check-6">no vices / no compromises: <span class="accent" id="vices-inline">set in settings</span></label>
          </div>
        </div>

        <div class="card">
          <div class="subtle" style="margin-bottom:8px;">optional reflection</div>
          <textarea id="today-notes" placeholder="quick reflection: what did God reveal today? where did you obey? where did you resist? what‚Äôs one win you‚Äôre grateful for?"></textarea>
        </div>

        <div class="card">
          <div class="subtle" id="endday-rule" style="margin-bottom:10px;">
            within 2 hours of bedtime, press ‚Äúend day.‚Äù
          </div>
          <button class="btn" id="end-day-btn">end day</button>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="settings" class="section">
        <div class="card">
          <div class="subtle" style="margin-bottom:10px;">setup (one time)</div>

          <div style="display:grid; gap:12px;">
            <div>
              <div class="subtle">start date</div>
              <input type="date" id="start-date">
            </div>

            <div>
              <div class="subtle">your dedicated gift (what you will share daily)</div>
              <input type="text" id="gift-text" placeholder="ex: my creative direction + strategy, my testimony, my art, my voice...">
            </div>

            <div>
              <div class="subtle">your surrendered vices / temptations</div>
              <input type="text" id="vices-text" placeholder="ex: doom scrolling, alcohol, porn, overeating, gossip, spending...">
            </div>

            <div class="row">
              <div style="flex:1;">
                <div class="subtle">wakeup time</div>
                <input type="time" id="wakeup-time" value="06:00">
              </div>
              <div style="flex:1;">
                <div class="subtle">bedtime</div>
                <input type="time" id="bedtime" value="22:00">
              </div>
            </div>

            <div>
              <div class="subtle">body weight (lbs)</div>
              <input type="number" id="body-weight" value="150" min="50" max="500">
            </div>

            <div class="card" style="margin:0; background: rgba(255,255,255,0.22);">
              <div class="subtle" style="text-align:center;">water goal</div>
              <div style="text-align:center; font-size:22px; font-weight:700; color: var(--accent); margin-top:6px;" id="computed-water">0 oz</div>
              <div class="subtle" style="text-align:center; margin-top:6px;">rule: 1/2 bodyweight in oz + 8 oz (daily movement)</div>
            </div>

            <button class="btn" id="save-settings-btn">save settings</button>
          </div>
        </div>

        <div class="card">
          <div class="subtle" style="margin-bottom:10px;">calendar reminders (optional)</div>
          <div class="subtle">these open google calendar + you hit save. set once, you‚Äôre good.</div>

          <div class="btn-row">
            <a class="btn secondary" id="cal-wakeup" href="#" target="_blank" rel="noopener noreferrer">add wakeup reminder</a>
            <a class="btn secondary" id="cal-midday" href="#" target="_blank" rel="noopener noreferrer">add midday check-in</a>
            <a class="btn secondary" id="cal-lastlap" href="#" target="_blank" rel="noopener noreferrer">add last-lap reminder (1 hr before bed)</a>
          </div>
        </div>
      </section>

      <!-- RULES -->
      <section id="rules" class="section">
        <div class="card rules">
          <h2>75 GIFTED</h2>

          <h3>daily mission</h3>
          <p>complete all 7 items before bedtime:</p>
          <ol>
            <li>P.R.A.Y. fervently (praise, repent, ask, YES!)</li>
            <li>drink your water goal</li>
            <li>read bible for 10 minutes</li>
            <li>serve weekly (where God is calling you to give most)</li>
            <li>share your gift publicly</li>
            <li>45 minutes of movement</li>
            <li>no vices / no compromises</li>
          </ol>

          <h3>the rules</h3>
          <p>within 2 hours of bedtime, press ‚Äúend day.‚Äù</p>
          <p>it's all or nothing. all items checked = win day + streak rises. one missing = loss + reset to 0.</p>
          <p>this is where we break the cycle of "not feeling like it" + adopting a steward's attitude to nurturing His gifts.</p>

          <h3>the goal</h3>
          <p>reach 75 consecutive days of victory. grow your gifts.</p>
          <p>you got this! love, ki</p>
        </div>
      </section>
    </main>

    <!-- bottom tabs -->
    <nav class="tabs">
      <button class="tab active" data-tab="today">today</button>
      <button class="tab" data-tab="settings">settings</button>
      <button class="tab" data-tab="rules">rules</button>
    </nav>
  </div>

  <!-- modal -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="icon" id="modal-icon">‚úì</div>
      <div class="title" id="modal-title">message</div>
      <div class="text" id="modal-text">‚Äî</div>
      <button class="btn" id="modal-ok">ok</button>
    </div>
  </div>

  <script>
    const APP_DATA_KEY = '75_gifted_data_v3';

    const DEFAULT_STATE = {
      currentStreak: 0,
      longestStreak: 0,
      history: [], // [{date, completed, streakAfter, notes}]
      settings: {
        startDate: null,
        wakeupTime: '06:00',
        bedtime: '22:00',
        bodyWeight: 150,
        giftText: '',
        vicesText: ''
      },
      today: {
        date: null,
        checks: [false,false,false,false,false,false,false],
        notes: '',
        ended: false
      }
    };

    let appState = structuredClone(DEFAULT_STATE);

    function getTodayString(){
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    }

    function loadData(){
      const saved = localStorage.getItem(APP_DATA_KEY);
      if (saved){
        try{
          const parsed = JSON.parse(saved);
          appState = { ...structuredClone(DEFAULT_STATE), ...parsed };
          appState.settings = { ...DEFAULT_STATE.settings, ...(parsed.settings || {}) };
          appState.today = { ...DEFAULT_STATE.today, ...(parsed.today || {}) };
          if (!Array.isArray(appState.today.checks) || appState.today.checks.length !== 7){
            appState.today.checks = [false,false,false,false,false,false,false];
          }
        } catch(e){
          appState = structuredClone(DEFAULT_STATE);
        }
      }
      checkNewDayAndAutoResetIfMissed();
    }

    function saveData(){
      localStorage.setItem(APP_DATA_KEY, JSON.stringify(appState));
    }

    function midnightify(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }

    function daysBetweenInclusive(startDateStr, endDateStr){
      if (!startDateStr) return 0;
      const start = midnightify(new Date(startDateStr + 'T00:00:00'));
      const end = midnightify(new Date(endDateStr + 'T00:00:00'));
      const diff = Math.floor((end - start) / (1000*60*60*24)) + 1;
      return diff > 0 ? diff : 0;
    }

    function getDaysElapsed(){
      if (!appState.settings.startDate) return 0;
      return daysBetweenInclusive(appState.settings.startDate, getTodayString());
    }

    // if a day passes and they never ended the day, treat it as a loss + reset
    function checkNewDayAndAutoResetIfMissed(){
      const today = getTodayString();

      if (appState.today.date && appState.today.date !== today && !appState.today.ended){
        appState.history.push({
          date: appState.today.date,
          completed: false,
          streakAfter: 0,
          notes: appState.today.notes || ''
        });
        appState.currentStreak = 0;
      }

      if (appState.today.date !== today){
        appState.today = {
          date: today,
          checks: [false,false,false,false,false,false,false],
          notes: '',
          ended: false
        };
        saveData();
      }
    }

    function formatDate(dateStr){
      const date = new Date(dateStr + 'T00:00:00');
      return date.toLocaleDateString('en-US', {
        weekday:'long', month:'long', day:'numeric', year:'numeric'
      }).toLowerCase();
    }

    function computeWaterOz(){
      const bw = Number(appState.settings.bodyWeight) || 150;
      return Math.round((bw * 0.5) + 8);
    }

    function minutesFromHHMM(hhmm){
      const [h,m] = String(hhmm||'00:00').split(':').map(Number);
      return (h*60) + (m||0);
    }

    function formatHMS(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const h = String(Math.floor(total/3600)).padStart(2,'0');
      const m = String(Math.floor((total%3600)/60)).padStart(2,'0');
      const s = String(total%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }

    function getMsUntilBedtime(){
      const now = new Date();
      const [bh,bm] = String(appState.settings.bedtime || '22:00').split(':').map(Number);
      const bed = new Date();
      bed.setHours(bh||22, bm||0, 0, 0);
      return bed - now;
    }

    function canEndDayNow(){
      const now = new Date();
      const currentMins = now.getHours()*60 + now.getMinutes();
      const bedtimeMins = minutesFromHHMM(appState.settings.bedtime || '22:00');
      return currentMins >= (bedtimeMins - 120) && currentMins <= bedtimeMins;
    }

    function showModal(icon, title, text){
      document.getElementById('modal-icon').textContent = icon;
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-text').textContent = text;
      document.getElementById('overlay').classList.add('active');
    }

    document.getElementById('modal-ok').addEventListener('click', () => {
      document.getElementById('overlay').classList.remove('active');
    });

    // google calendar links
    function pad2(n){ return String(n).padStart(2,'0'); }

    function makeGCalLink({ title, details, hour, minute }){
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/New_York';
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());

      // google template expects local-ish, we keep it simple for your use case
      const dateStr = `${yyyy}${mm}${dd}`;
      const start = `${dateStr}T${pad2(hour)}${pad2(minute)}00`;
      const endHour = Math.min(23, hour + 1);
      const end = `${dateStr}T${pad2(endHour)}${pad2(minute)}00`;

      const text = encodeURIComponent(title);
      const det = encodeURIComponent(details);
      const recur = encodeURIComponent('RRULE:FREQ=DAILY');

      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${text}&details=${det}&dates=${start}/${end}&recur=${recur}&ctz=${encodeURIComponent(tz)}`;
    }

    function updateCalendarLinks(){
      const wake = (appState.settings.wakeupTime || '06:00').split(':').map(Number);
      const bed = (appState.settings.bedtime || '22:00').split(':').map(Number);

      const wakeMins = (wake[0]*60) + (wake[1]||0);
      const bedMins = (bed[0]*60) + (bed[1]||0);

      const middayMins = Math.floor((wakeMins + bedMins) / 2);
      const lastlapMins = Math.max(0, bedMins - 60);

      const middayH = Math.floor(middayMins/60);
      const middayM = middayMins%60;

      const lastlapH = Math.floor(lastlapMins/60);
      const lastlapM = lastlapMins%60;

      const gift = (appState.settings.giftText || 'your gift').trim();
      const vices = (appState.settings.vicesText || 'your surrendered vices').trim();

      document.getElementById('cal-wakeup').href = makeGCalLink({
        title: '75 GIFTED: wake up + pray',
        details: `rise + seek. gift: ${gift}. surrendered: ${vices}.`,
        hour: wake[0]||6,
        minute: wake[1]||0
      });

      document.getElementById('cal-midday').href = makeGCalLink({
        title: '75 GIFTED: midday check-in',
        details: `quick check: complete the 7 before bedtime. gift: ${gift}.`,
        hour: middayH,
        minute: middayM
      });

      document.getElementById('cal-lastlap').href = makeGCalLink({
        title: '75 GIFTED: last lap',
        details: `one hour left. finish strong. all or nothing.`,
        hour: lastlapH,
        minute: lastlapM
      });
    }

    // UI updates
    function updateTodayUI(){
      document.getElementById('today-date').textContent = formatDate(appState.today.date);

      const waterOz = computeWaterOz();
      document.getElementById('water-target').textContent = `(${waterOz} oz)`;

      const gift = (appState.settings.giftText || '').trim();
      const vices = (appState.settings.vicesText || '').trim();

      document.getElementById('gift-display').textContent = gift ? gift : 'set in settings';
      document.getElementById('vices-display').textContent = vices ? vices : 'set in settings';
      document.getElementById('gift-inline').textContent = gift ? gift : 'set in settings';
      document.getElementById('vices-inline').textContent = vices ? vices : 'set in settings';

      for (let i=0;i<7;i++){
        const el = document.getElementById(`check-${i}`);
        el.checked = !!appState.today.checks[i];
      }

      document.getElementById('today-notes').value = appState.today.notes || '';

      document.getElementById('stat-current').textContent = appState.currentStreak;
      document.getElementById('stat-longest').textContent = appState.longestStreak;
      document.getElementById('stat-elapsed').textContent = getDaysElapsed();

      const btn = document.getElementById('end-day-btn');
      btn.disabled = !canEndDayNow();

      drawChart();
    }

    function updateSettingsUI(){
      document.getElementById('start-date').value = appState.settings.startDate || '';
      document.getElementById('wakeup-time').value = appState.settings.wakeupTime || '06:00';
      document.getElementById('bedtime').value = appState.settings.bedtime || '22:00';
      document.getElementById('body-weight').value = appState.settings.bodyWeight || 150;
      document.getElementById('gift-text').value = appState.settings.giftText || '';
      document.getElementById('vices-text').value = appState.settings.vicesText || '';

      document.getElementById('computed-water').textContent = `${computeWaterOz()} oz`;
      updateCalendarLinks();
    }

    // chart
    function drawChart(){
      const canvas = document.getElementById('streak-chart');
      const ctx = canvas.getContext('2d');

      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);

      const w = rect.width;
      const h = rect.height;
      ctx.clearRect(0,0,w,h);

      const data = appState.history.slice(-75);
      if (data.length === 0){
        ctx.fillStyle = 'rgba(71,99,19,0.65)';
        ctx.font = '600 14px Montserrat, system-ui, -apple-system, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('no chart data yet (end a day to start the line)', w/2, h/2);
        return;
      }

      const maxVal = Math.max(10, ...data.map(d => d.streakAfter), appState.currentStreak);
      const pad = 34;
      const cw = w - pad*2;
      const ch = h - pad*2;

      ctx.strokeStyle = 'rgba(71,99,19,0.14)';
      ctx.lineWidth = 1;
      for (let i=0;i<=5;i++){
        const y = pad + (ch/5)*i;
        ctx.beginPath();
        ctx.moveTo(pad, y);
        ctx.lineTo(w-pad, y);
        ctx.stroke();
      }

      const xStep = cw / Math.max(data.length - 1, 1);
      const yScale = ch / maxVal;

      ctx.strokeStyle = 'rgba(237,168,238,0.95)';
      ctx.lineWidth = 2.6;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.beginPath();

      data.forEach((p, idx) => {
        const x = pad + idx*xStep;
        const y = pad + ch - (p.streakAfter * yScale);
        if (idx === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      });
      ctx.stroke();

      ctx.fillStyle = 'rgba(237,168,238,0.95)';
      data.forEach((p, idx) => {
        const x = pad + idx*xStep;
        const y = pad + ch - (p.streakAfter * yScale);
        ctx.beginPath();
        ctx.arc(x,y,2.8,0,Math.PI*2);
        ctx.fill();
      });
    }

    // countdown tick
    function startCountdown(){
      const el = document.getElementById('countdown');
      function tick(){
        const ms = getMsUntilBedtime();
        el.textContent = formatHMS(ms);
        document.getElementById('end-day-btn').disabled = !canEndDayNow();
      }
      tick();
      setInterval(tick, 1000);
    }

    // handlers: checkboxes
    for (let i=0;i<7;i++){
      document.getElementById(`check-${i}`).addEventListener('change', (e) => {
        appState.today.checks[i] = e.target.checked;
        saveData();
      });
    }

    document.getElementById('today-notes').addEventListener('input', (e) => {
      appState.today.notes = e.target.value;
      saveData();
    });

    // settings bindings
    document.getElementById('start-date').addEventListener('change', (e) => {
      appState.settings.startDate = e.target.value || null;
      saveData();
      updateTodayUI();
      updateCalendarLinks();
    });

    document.getElementById('gift-text').addEventListener('input', (e) => {
      appState.settings.giftText = e.target.value || '';
      saveData();
      updateTodayUI();
      updateCalendarLinks();
    });

    document.getElementById('vices-text').addEventListener('input', (e) => {
      appState.settings.vicesText = e.target.value || '';
      saveData();
      updateTodayUI();
      updateCalendarLinks();
    });

    document.getElementById('wakeup-time').addEventListener('change', (e) => {
      appState.settings.wakeupTime = e.target.value || '06:00';
      saveData();
      updateCalendarLinks();
    });

    document.getElementById('bedtime').addEventListener('change', (e) => {
      appState.settings.bedtime = e.target.value || '22:00';
      saveData();
      updateTodayUI();
      updateCalendarLinks();
    });

    document.getElementById('body-weight').addEventListener('input', (e) => {
      appState.settings.bodyWeight = Number(e.target.value) || 150;
      saveData();
      updateSettingsUI();
      updateTodayUI();
    });

    document.getElementById('save-settings-btn').addEventListener('click', () => {
      saveData();
      updateSettingsUI();
      updateTodayUI();
      showModal('‚úÖ', 'saved', 'settings saved. now go win today.');
    });

    // end day logic
    document.getElementById('end-day-btn').addEventListener('click', () => {
      if (!canEndDayNow()){
        showModal('‚è≥', 'not yet', 'you can only end the day within 2 hours of bedtime.');
        return;
      }

      const allChecked = appState.today.checks.every(Boolean);

      if (allChecked){
        appState.currentStreak += 1;
        appState.longestStreak = Math.max(appState.longestStreak, appState.currentStreak);

        appState.history.push({
          date: appState.today.date,
          completed: true,
          streakAfter: appState.currentStreak,
          notes: appState.today.notes || ''
        });

        appState.today.ended = true;
        appState.today.checks = [false,false,false,false,false,false,false];
        appState.today.notes = '';

        saveData();
        showModal('üî•', 'win day', `all 7 completed. streak: ${appState.currentStreak}`);
        checkNewDayAndAutoResetIfMissed();
        updateTodayUI();
      } else {
        appState.currentStreak = 0;

        appState.history.push({
          date: appState.today.date,
          completed: false,
          streakAfter: 0,
          notes: appState.today.notes || ''
        });

        appState.today.ended = true;
        appState.today.checks = [false,false,false,false,false,false,false];
        appState.today.notes = '';

        saveData();
        showModal('üíî', 'loss day', 'one missing. reset to 0. tomorrow we move like a steward.');
        checkNewDayAndAutoResetIfMissed();
        updateTodayUI();
      }
    });

    // bottom tabs
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;

        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(tab).classList.add('active');

        if (tab === 'today') setTimeout(drawChart, 50);
        if (tab === 'settings') setTimeout(updateCalendarLinks, 50);
      });
    });

    window.addEventListener('resize', () => drawChart());

    // init
    loadData();
    updateSettingsUI();
    updateTodayUI();
    startCountdown();
  </script>
</body>
</html>
